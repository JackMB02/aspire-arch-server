<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Aspire Design Lab - Admin Dashboard</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Helvetica+Neue:wght@200;300;400&display=swap">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="admin.css">
  </head>
  <body>
    <!-- Login Screen -->
    <div id="loginScreen">
      <!-- ... existing login code ... -->
    </div>

    <!-- Dashboard -->
    <div id="dashboard" class="hidden">
      <div class="dashboard-container">
        <!-- Sidebar -->
        <div class="sidebar" id="sidebar">
          <!-- ... existing sidebar code ... -->
        </div>

        <!-- Main Content -->
        <div class="main-content">
          <!-- Header -->
          <div class="header">
            <!-- ... existing header code ... -->
          </div>

          <!-- Content Sections -->
          <div class="content">
            <!-- ... other sections ... -->

            <!-- Design Projects Management Section -->
            <div id="designSection" class="section hidden">
              <div class="card">
                <div class="card-header">
                  <h3 class="card-title">Design Projects Management</h3>
                  <div class="button-group" style="margin: 0;">
                    <button id="refreshDesign" class="btn-secondary">
                      <i class="fas fa-sync-alt"></i> Refresh All
                    </button>
                  </div>
                </div>

                <!-- Design Projects Stats -->
                <div class="stats-row">
                  <div class="stat-mini-card">
                    <div class="stat-mini-value" id="designTotalProjects">0</div>
                    <div class="stat-mini-label">Total Projects</div>
                  </div>
                  <div class="stat-mini-card">
                    <div class="stat-mini-value" id="designAcademicProjects">0</div>
                    <div class="stat-mini-label">Academic Projects</div>
                  </div>
                  <div class="stat-mini-card">
                    <div class="stat-mini-value" id="designProfessionalProjects">0</div>
                    <div class="stat-mini-label">Professional Projects</div>
                  </div>
                  <div class="stat-mini-card">
                    <div class="stat-mini-value" id="designCompetitionProjects">0</div>
                    <div class="stat-mini-label">Competition Projects</div>
                  </div>
                </div>

                <!-- Design Projects Tabs -->
                <div class="get-involved-tabs">
                  <button class="get-involved-tab active" data-tab="design-all">
                    <i class="fas fa-th"></i> All Projects
                  </button>
                  <button class="get-involved-tab" data-tab="design-academic">
                    <i class="fas fa-graduation-cap"></i> Academic
                  </button>
                  <button class="get-involved-tab" data-tab="design-professional">
                    <i class="fas fa-briefcase"></i> Professional
                  </button>
                  <button class="get-involved-tab" data-tab="design-competition">
                    <i class="fas fa-trophy"></i> Competition
                  </button>
                </div>

                <!-- All Projects Tab -->
                <div id="design-allTab" class="get-involved-content active">
                  <div class="card-header">
                    <h4 class="card-title">All Design Projects</h4>
                    <div class="button-group" style="margin: 0;">
                      <button onclick="loadDesignProjects()" class="btn-secondary">
                        <i class="fas fa-sync-alt"></i> Refresh
                      </button>
                      <button onclick="showAddDesignProjectModal()" class="btn-primary">
                        <i class="fas fa-plus"></i> Add Project
                      </button>
                    </div>
                  </div>
                  <div id="designProjectsList" class="items-grid">
                    <!-- Design projects will be loaded here -->
                  </div>
                </div>

                <!-- Academic Projects Tab -->
                <div id="design-academicTab" class="get-involved-content">
                  <div class="card-header">
                    <h4 class="card-title">Academic Design Projects</h4>
                    <div class="button-group" style="margin: 0;">
                      <button onclick="loadAcademicProjects()" class="btn-secondary">
                        <i class="fas fa-sync-alt"></i> Refresh
                      </button>
                      <button onclick="showAddDesignProjectModal('academic')" class="btn-primary">
                        <i class="fas fa-plus"></i> Add Academic Project
                      </button>
                    </div>
                  </div>
                  <div id="academicProjectsList" class="items-grid">
                    <!-- Academic projects will be loaded here -->
                  </div>
                </div>

                <!-- Professional Projects Tab -->
                <div id="design-professionalTab" class="get-involved-content">
                  <div class="card-header">
                    <h4 class="card-title">Professional Design Projects</h4>
                    <div class="button-group" style="margin: 0;">
                      <button onclick="loadProfessionalProjects()" class="btn-secondary">
                        <i class="fas fa-sync-alt"></i> Refresh
                      </button>
                      <button onclick="showAddDesignProjectModal('professional')" class="btn-primary">
                        <i class="fas fa-plus"></i> Add Professional Project
                      </button>
                    </div>
                  </div>
                  <div id="professionalProjectsList" class="items-grid">
                    <!-- Professional projects will be loaded here -->
                  </div>
                </div>

                <!-- Competition Projects Tab -->
                <div id="design-competitionTab" class="get-involved-content">
                  <div class="card-header">
                    <h4 class="card-title">Competition Design Projects</h4>
                    <div class="button-group" style="margin: 0;">
                      <button onclick="loadCompetitionProjects()" class="btn-secondary">
                        <i class="fas fa-sync-alt"></i> Refresh
                      </button>
                      <button onclick="showAddDesignProjectModal('competition')" class="btn-primary">
                        <i class="fas fa-plus"></i> Add Competition Project
                      </button>
                    </div>
                  </div>
                  <div id="competitionProjectsList" class="items-grid">
                    <!-- Competition projects will be loaded here -->
                  </div>
                </div>
              </div>
            </div>

            <!-- ... other sections ... -->
          </div>
        </div>
      </div>
    </div>

    <!-- Mobile Overlay -->
    <div class="overlay" id="overlay"></div>

    <!-- Design Project Modals -->
    <!-- Add Design Project Modal -->
    <div id="addDesignProjectModal" class="modal hidden">
      <div class="card">
        <div class="card-header">
          <h3 class="card-title">Add Design Project</h3>
          <button onclick="hideAddDesignProjectModal()" class="btn-secondary">
            <i class="fas fa-times"></i>
          </button>
        </div>
        <form id="addDesignProjectForm">
          <div class="form-grid">
            <div class="input-group full-width">
              <label for="designProjectTitle">Title *</label>
              <input id="designProjectTitle" type="text" required />
            </div>
            <div class="input-group full-width">
              <label for="designProjectSummary">Summary *</label>
              <textarea id="designProjectSummary" required></textarea>
            </div>
            <div class="input-group full-width">
              <label for="designProjectDescription">Description *</label>
              <textarea id="designProjectDescription" required></textarea>
            </div>
            <div class="input-group">
              <label for="designProjectCategory">Category *</label>
              <select id="designProjectCategory" required>
                <option value="academic">Academic</option>
                <option value="professional">Professional</option>
                <option value="competition">Competition</option>
              </select>
            </div>
            
            <!-- Image Upload Section -->
            <div class="input-group full-width">
              <label for="designProjectMainImage">Main Image *</label>
              <div class="image-upload-container">
                <input type="file" id="designProjectMainImage" accept="image/*" required />
                <div id="mainImagePreview" class="image-preview"></div>
                <small style="color: var(--text-muted);">Upload main image for the project (max 5MB)</small>
              </div>
            </div>
            
            <div class="input-group full-width">
              <label for="designProjectGalleryImages">Gallery Images</label>
              <div class="image-upload-container">
                <input type="file" id="designProjectGalleryImages" multiple accept="image/*" />
                <div id="galleryImagesPreview" class="gallery-preview"></div>
                <small style="color: var(--text-muted);">Upload additional images for gallery (max 5 files, 5MB each)</small>
              </div>
            </div>
            
            <div class="input-group">
              <label for="designProjectDisplayOrder">Display Order</label>
              <input id="designProjectDisplayOrder" type="number" min="0" value="0" />
            </div>
            <div class="input-group">
              <label class="toggle-switch" style="display: flex; align-items: center; gap: 1rem;">
                <input type="checkbox" id="designProjectFeatured" checked>
                <span class="toggle-slider"></span>
                <span>Featured</span>
              </label>
            </div>
            <div class="input-group">
              <label class="toggle-switch" style="display: flex; align-items: center; gap: 1rem;">
                <input type="checkbox" id="designProjectPublished" checked>
                <span class="toggle-slider"></span>
                <span>Published</span>
              </label>
            </div>
          </div>
          <div id="uploadProgress" class="progress" style="display:none">
            <div class="progress-bar"></div>
          </div>
          <div class="button-group">
            <button type="submit" class="btn-primary">
              <i class="fas fa-save"></i> Add Project
            </button>
            <button type="button" onclick="hideAddDesignProjectModal()" class="btn-secondary">
              <i class="fas fa-times"></i> Cancel
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- JavaScript Section -->
    <script>
      const API_BASE_URL = 'http://localhost:4000/api';
      let authToken = null;
      let currentDesignTab = 'design-all';
      let designStats = {
        total: 0,
        academic: 0,
        professional: 0,
        competition: 0,
        featured: 0
      };

      // Image upload variables
      let mainImageFile = null;
      let galleryImageFiles = [];

      // DOM Elements
      const loginScreen = document.getElementById('loginScreen');
      const dashboard = document.getElementById('dashboard');
      const sidebar = document.getElementById('sidebar');
      const mobileMenuBtn = document.getElementById('mobileMenuBtn');
      const overlay = document.getElementById('overlay');
      const pageTitle = document.getElementById('pageTitle');
      const navItems = document.querySelectorAll('.nav-item');
      const sections = document.querySelectorAll('.section');

      // API Helper Functions
      async function apiRequest(endpoint, options = {}) {
        const url = `${API_BASE_URL}${endpoint}`;
        
        // Get current token
        const currentToken = authToken || localStorage.getItem('aspire_token');
        
        const config = {
          headers: {
            'Content-Type': 'application/json',
            ...(currentToken ? { 'Authorization': `Bearer ${currentToken}` } : {}),
            ...options.headers,
          },
          ...options,
        };

        // For FormData requests, remove Content-Type header (browser will set it automatically)
        if (options.body instanceof FormData) {
          delete config.headers['Content-Type'];
        }

        try {
          console.log(`ðŸ”„ API Request: ${options.method || 'GET'} ${url}`);
          
          const response = await fetch(url, config);
          
          if (response.status === 401) {
            // Token is invalid/expired
            console.error('âŒ Authentication failed (401)');
            localStorage.removeItem('aspire_token');
            authToken = null;
            throw new Error('Authentication failed. Please login again.');
          }
          
          if (!response.ok) {
            const errorText = await response.text();
            console.error('âŒ API Error Response:', errorText);
            let errorData;
            try {
              errorData = JSON.parse(errorText);
            } catch {
              errorData = { error: `HTTP ${response.status}: ${response.statusText}` };
            }
            throw new Error(errorData.error || `HTTP error! status: ${response.status}`);
          }
          
          const data = await response.json();
          console.log(`âœ… API Success for ${endpoint}`);
          return data;
        } catch (error) {
          console.error('âŒ API Request failed:', error);
          
          // If it's an auth error, redirect to login
          if (error.message.includes('Authentication failed') || error.message.includes('Authentication required')) {
            showLogin();
          }
          
          throw error;
        }
      }

      // Enhanced uploadFile function with better error handling
      async function uploadFile(file, type) {
        const formData = new FormData();
        formData.append('file', file);
        formData.append('type', type);

        try {
          console.log(`ðŸ“¤ Uploading ${type} file:`, file.name, file.size, file.type);
          
          const response = await fetch(`${API_BASE_URL}/upload`, {
            method: 'POST',
            headers: {
              'Authorization': `Bearer ${authToken || localStorage.getItem('aspire_token')}`
            },
            body: formData
          });

          console.log('ðŸ“¤ Upload response status:', response.status);
          
          if (!response.ok) {
            const errorText = await response.text();
            console.error('âŒ Upload failed with response:', errorText);
            throw new Error(`Upload failed: ${response.status} - ${errorText}`);
          }

          const data = await response.json();
          console.log('ðŸ“¤ Upload response data:', data);
          
          // Handle different response formats
          const fileUrl = data.fileUrl || data.url || data.path || data.filePath;
          if (!fileUrl) {
            console.error('âŒ No file URL in response:', data);
            throw new Error('Upload response missing file URL');
          }
          
          console.log('âœ… Upload successful, file URL:', fileUrl);
          return fileUrl;
        } catch (error) {
          console.error('âŒ File upload error:', error);
          throw error;
        }
      }

      // Image Upload Functions
      function handleMainImageUpload(event) {
        const file = event.target.files[0];
        if (!file) return;

        // Validate file size (5MB max)
        if (file.size > 5 * 1024 * 1024) {
          alert('Main image must be less than 5MB');
          event.target.value = '';
          return;
        }

        // Validate file type
        if (!file.type.startsWith('image/')) {
          alert('Please select an image file');
          event.target.value = '';
          return;
        }

        mainImageFile = file;
        previewImage(file, 'mainImagePreview');
      }

      function handleGalleryImagesUpload(event) {
        const files = Array.from(event.target.files);
        galleryImageFiles = [];

        // Validate files
        for (let file of files) {
          if (file.size > 5 * 1024 * 1024) {
            alert(`File ${file.name} is too large. Max size is 5MB.`);
            continue;
          }
          if (!file.type.startsWith('image/')) {
            alert(`File ${file.name} is not an image.`);
            continue;
          }
          galleryImageFiles.push(file);
        }

        // Update preview
        previewGalleryImages(galleryImageFiles);
      }

      function previewImage(file, previewElementId) {
        const reader = new FileReader();
        const preview = document.getElementById(previewElementId);
        
        reader.onload = function(e) {
          preview.innerHTML = `
            <div class="preview-item">
              <img src="${e.target.result}" alt="Preview" />
              <button type="button" onclick="removeImage('${previewElementId}')" class="btn-danger">
                <i class="fas fa-times"></i>
              </button>
            </div>
          `;
        };
        
        reader.readAsDataURL(file);
      }

      function previewGalleryImages(files) {
        const preview = document.getElementById('galleryImagesPreview');
        preview.innerHTML = '';

        files.forEach((file, index) => {
          const reader = new FileReader();
          
          reader.onload = function(e) {
            const previewItem = document.createElement('div');
            previewItem.className = 'preview-item';
            previewItem.innerHTML = `
              <img src="${e.target.result}" alt="Gallery preview ${index + 1}" />
              <button type="button" onclick="removeGalleryImage(${index})" class="btn-danger">
                <i class="fas fa-times"></i>
              </button>
            `;
            preview.appendChild(previewItem);
          };
          
          reader.readAsDataURL(file);
        });
      }

      function removeImage(previewElementId) {
        const preview = document.getElementById(previewElementId);
        preview.innerHTML = '';
        mainImageFile = null;
        document.getElementById('designProjectMainImage').value = '';
      }

      function removeGalleryImage(index) {
        galleryImageFiles.splice(index, 1);
        previewGalleryImages(galleryImageFiles);
        // Reset file input to reflect removed files
        document.getElementById('designProjectGalleryImages').value = '';
      }

      // Design Projects Management Functions
      document.querySelectorAll('.get-involved-tab[data-tab]').forEach(tab => {
        tab.addEventListener('click', () => {
          const tabName = tab.getAttribute('data-tab');
          if (tabName.startsWith('design-')) {
            showDesignTab(tabName);
          }
        });
      });

      function showDesignTab(tabName) {
        // Hide all design tabs
        document.querySelectorAll('.get-involved-content').forEach(content => {
          content.classList.remove('active');
        });
        document.querySelectorAll('.get-involved-tab').forEach(tab => {
          tab.classList.remove('active');
        });

        // Show selected tab
        document.getElementById(tabName + 'Tab').classList.add('active');
        document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');
        currentDesignTab = tabName;

        // Load data for the tab
        switch(tabName) {
          case 'design-all':
            loadDesignProjects();
            break;
          case 'design-academic':
            loadAcademicProjects();
            break;
          case 'design-professional':
            loadProfessionalProjects();
            break;
          case 'design-competition':
            loadCompetitionProjects();
            break;
        }
      }

      // Load Design Stats for Dashboard
      async function loadDesignStats() {
        try {
          const data = await apiRequest('/design/admin/stats');
          designStats.total = data.data.total || 0;
          designStats.academic = data.data.academic || 0;
          designStats.professional = data.data.professional || 0;
          designStats.competition = data.data.competition || 0;
          designStats.featured = data.data.featured || 0;

          // Update dashboard stats
          document.getElementById('designProjectsCount').textContent = designStats.total;
          document.getElementById('designTotalProjects').textContent = designStats.total;
          document.getElementById('designAcademicProjects').textContent = designStats.academic;
          document.getElementById('designProfessionalProjects').textContent = designStats.professional;
          document.getElementById('designCompetitionProjects').textContent = designStats.competition;
        } catch (error) {
          console.error('Failed to load design stats:', error);
        }
      }

      // Load All Design Projects
      async function loadDesignProjects() {
        try {
          const data = await apiRequest('/design/admin/projects');
          const container = document.getElementById('designProjectsList');
          container.innerHTML = '';

          if (!data.data || data.data.length === 0) {
            container.innerHTML = '<p style="text-align: center; color: var(--text-muted); padding: 2rem;">No design projects found.</p>';
            return;
          }

          data.data.forEach(project => {
            const el = createDesignProjectElement(project);
            container.appendChild(el);
          });
        } catch (error) {
          console.error('Failed to load design projects:', error);
        }
      }

      // Load Academic Projects
      async function loadAcademicProjects() {
        try {
          const data = await apiRequest('/design/projects/academic');
          const container = document.getElementById('academicProjectsList');
          container.innerHTML = '';

          if (!data.data || data.data.length === 0) {
            container.innerHTML = '<p style="text-align: center; color: var(--text-muted); padding: 2rem;">No academic projects found.</p>';
            return;
          }

          data.data.forEach(project => {
            const el = createDesignProjectElement(project);
            container.appendChild(el);
          });
        } catch (error) {
          console.error('Failed to load academic projects:', error);
        }
      }

      // Load Professional Projects
      async function loadProfessionalProjects() {
        try {
          const data = await apiRequest('/design/projects/professional');
          const container = document.getElementById('professionalProjectsList');
          container.innerHTML = '';

          if (!data.data || data.data.length === 0) {
            container.innerHTML = '<p style="text-align: center; color: var(--text-muted); padding: 2rem;">No professional projects found.</p>';
            return;
          }

          data.data.forEach(project => {
            const el = createDesignProjectElement(project);
            container.appendChild(el);
          });
        } catch (error) {
          console.error('Failed to load professional projects:', error);
        }
      }

      // Load Competition Projects
      async function loadCompetitionProjects() {
        try {
          const data = await apiRequest('/design/projects/competition');
          const container = document.getElementById('competitionProjectsList');
          container.innerHTML = '';

          if (!data.data || data.data.length === 0) {
            container.innerHTML = '<p style="text-align: center; color: var(--text-muted); padding: 2rem;">No competition projects found.</p>';
            return;
          }

          data.data.forEach(project => {
            const el = createDesignProjectElement(project);
            container.appendChild(el);
          });
        } catch (error) {
          console.error('Failed to load competition projects:', error);
        }
      }

      function createDesignProjectElement(project) {
        const el = document.createElement('div');
        el.className = 'item';
        
        const content = document.createElement('div');
        content.className = 'item-content';
        
        const title = document.createElement('h4');
        title.className = 'item-title';
        title.textContent = project.title;
        
        const meta = document.createElement('div');
        meta.className = 'item-meta';
        
        const category = document.createElement('span');
        category.className = 'item-type';
        category.textContent = project.category;
        
        const status = document.createElement('span');
        status.className = 'item-date';
        status.textContent = project.is_published ? 'Published' : 'Draft';
        
        meta.appendChild(category);
        meta.appendChild(status);
        
        const preview = document.createElement('div');
        preview.className = 'item-preview';
        preview.textContent = project.summary || 'No summary available';
        
        // Add image preview if available
        if (project.main_image) {
          const img = document.createElement('img');
          img.src = project.main_image;
          img.alt = project.title;
          img.style.width = '100px';
          img.style.height = '80px';
          img.style.objectFit = 'cover';
          img.style.borderRadius = '6px';
          img.style.marginLeft = '1rem';
          img.style.border = '1px solid var(--border-light)';
          el.appendChild(img);
        }
        
        content.appendChild(title);
        content.appendChild(meta);
        content.appendChild(preview);

        const actions = document.createElement('div');
        actions.className = 'item-actions';
        
        const editBtn = document.createElement('button');
        editBtn.className = 'btn-secondary';
        editBtn.innerHTML = '<i class="fas fa-edit"></i> Edit';
        editBtn.onclick = () => editDesignProject(project);
        
        const toggleBtn = document.createElement('button');
        toggleBtn.className = project.is_published ? 'btn-warning' : 'btn-primary';
        toggleBtn.innerHTML = `<i class="fas ${project.is_published ? 'fa-eye-slash' : 'fa-eye'}"></i> ${project.is_published ? 'Unpublish' : 'Publish'}`;
        toggleBtn.onclick = async () => {
          await toggleDesignProject(project.id, !project.is_published);
        };
        
        const del = document.createElement('button');
        del.className = 'btn-danger';
        del.innerHTML = '<i class="fas fa-trash"></i> Delete';
        del.onclick = async () => {
          if (confirm('Are you sure you want to delete this design project?')) {
            await deleteDesignProject(project.id);
          }
        };
        
        actions.appendChild(editBtn);
        actions.appendChild(toggleBtn);
        actions.appendChild(del);
        content.appendChild(actions);
        
        el.appendChild(content);
        return el;
      }

      // Modal Functions for Design Projects
      function showAddDesignProjectModal(category = null) {
        if (category) {
          document.getElementById('designProjectCategory').value = category;
        }
        document.getElementById('addDesignProjectModal').classList.remove('hidden');
        
        // Set up image upload event listeners
        document.getElementById('designProjectMainImage').addEventListener('change', handleMainImageUpload);
        document.getElementById('designProjectGalleryImages').addEventListener('change', handleGalleryImagesUpload);
      }

      function hideAddDesignProjectModal() {
        document.getElementById('addDesignProjectModal').classList.add('hidden');
        document.getElementById('addDesignProjectForm').reset();
        
        // Reset image previews and files
        document.getElementById('mainImagePreview').innerHTML = '';
        document.getElementById('galleryImagesPreview').innerHTML = '';
        mainImageFile = null;
        galleryImageFiles = [];
        
        // Remove event listeners to prevent duplicates
        document.getElementById('designProjectMainImage').removeEventListener('change', handleMainImageUpload);
        document.getElementById('designProjectGalleryImages').removeEventListener('change', handleGalleryImagesUpload);
      }

      // Form Submissions for Design Projects
      document.getElementById('addDesignProjectForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const submitBtn = document.getElementById('addDesignProjectForm').querySelector('button[type="submit"]');
        const originalText = submitBtn.innerHTML;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Adding...';
        submitBtn.disabled = true;

        // Show upload progress
        const progressBar = document.querySelector('#uploadProgress .progress-bar');
        document.getElementById('uploadProgress').style.display = 'block';
        progressBar.style.width = '0%';

        try {
          // Validate main image
          if (!mainImageFile) {
            throw new Error('Please upload a main image for the project');
          }

          // Upload main image
          progressBar.style.width = '25%';
          const mainImageUrl = await uploadFile(mainImageFile, 'design-main');
          
          // Upload gallery images
          progressBar.style.width = '50%');
          const galleryImageUrls = [];
          for (let i = 0; i < galleryImageFiles.length; i++) {
            const url = await uploadFile(galleryImageFiles[i], 'design-gallery');
            galleryImageUrls.push(url);
            
            // Update progress
            const progress = 50 + (i / galleryImageFiles.length) * 50;
            progressBar.style.width = `${progress}%`;
          }

          progressBar.style.width = '100%');

          const projectData = {
            title: document.getElementById('designProjectTitle').value,
            summary: document.getElementById('designProjectSummary').value,
            description: document.getElementById('designProjectDescription').value,
            category: document.getElementById('designProjectCategory').value,
            main_image: mainImageUrl,
            gallery_images: galleryImageUrls,
            display_order: parseInt(document.getElementById('designProjectDisplayOrder').value) || 0,
            is_featured: document.getElementById('designProjectFeatured').checked,
            is_published: document.getElementById('designProjectPublished').checked
          };

          await apiRequest('/design/projects', {
            method: 'POST',
            body: JSON.stringify(projectData)
          });
          
          hideAddDesignProjectModal();
          loadDesignStats();
          showDesignTab(currentDesignTab);
          alert('Design project added successfully!');
        } catch (error) {
          console.error('Failed to add design project:', error);
          alert('Failed to add design project: ' + error.message);
        } finally {
          submitBtn.innerHTML = originalText;
          submitBtn.disabled = false;
          document.getElementById('uploadProgress').style.display = 'none';
        }
      });

      // Placeholder functions for future implementation
      async function toggleDesignProject(id, published) {
        try {
          await apiRequest(`/design/projects/${id}/toggle`, {
            method: 'PATCH'
          });
          loadDesignStats();
          showDesignTab(currentDesignTab);
        } catch (error) {
          console.error('Failed to toggle design project:', error);
          alert('Failed to toggle design project: ' + error.message);
        }
      }

      async function deleteDesignProject(id) {
        try {
          await apiRequest(`/design/projects/${id}`, {
            method: 'DELETE'
          });
          loadDesignStats();
          showDesignTab(currentDesignTab);
          alert('Design project deleted successfully!');
        } catch (error) {
          console.error('Failed to delete design project:', error);
          alert('Failed to delete design project: ' + error.message);
        }
      }

      function editDesignProject(project) {
        alert('Edit design project functionality coming soon!');
      }

      // Add to the refresh buttons
      document.getElementById('refreshDesign').onclick = () => {
        loadDesignStats();
        showDesignTab(currentDesignTab);
      };

      // Load Dashboard Data
      async function loadDashboardData() {
        try {
          console.log('ðŸ“Š Loading dashboard data...');
          await loadDesignStats();
        } catch (error) {
          console.error('Failed to load dashboard data:', error);
        }
      }

      // Navigation
      navItems.forEach(item => {
        item.addEventListener('click', () => {
          const section = item.getAttribute('data-section');
          showSection(section);
          
          // Update active nav item
          navItems.forEach(nav => nav.classList.remove('active'));
          item.classList.add('active');
          
          // Update page title
          pageTitle.textContent = item.querySelector('span').textContent;
          
          // Load section-specific data
          if (section === 'design') {
            loadDesignStats();
            showDesignTab('design-all');
          }
          
          // Close mobile menu
          if (window.innerWidth <= 1024) {
            sidebar.classList.remove('open');
            overlay.classList.remove('active');
          }
        });
      });

      function showSection(sectionName) {
        sections.forEach(section => {
          section.classList.add('hidden');
        });
        const targetSection = document.getElementById(sectionName + 'Section');
        if (targetSection) {
          targetSection.classList.remove('hidden');
        }
      }

      // Logout
      document.getElementById('logoutBtn').onclick = () => { 
        authToken = null; 
        localStorage.removeItem('aspire_token'); 
        dashboard.classList.add('hidden'); 
        loginScreen.classList.remove('hidden'); 
      };

      async function showDashboard() {
        loginScreen.classList.add('hidden');
        dashboard.classList.remove('hidden');
        authToken = localStorage.getItem('aspire_token');
        
        if (!authToken) {
          showLogin();
          return;
        }
        
        await loadDashboardData();
      }

      // Auto show if token present
      if (localStorage.getItem('aspire_token')) { 
        showDashboard(); 
      }
    </script>
  </body>
</html>